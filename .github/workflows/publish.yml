name: Publish to Maven Central

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (without v prefix, e.g., 1.0.1)'
        required: true
        type: string

env:
  GROUP_ID: guru.clanker
  ARTIFACT_ID: slop-publish

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Determine version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Publishing guru.clanker:slop-publish:$VERSION"
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Import GPG key
        run: |
          echo "${{ secrets.GPG_SECRET_KEY }}" | gpg --batch --import
      
      - name: Cache Amper
        uses: actions/cache@v4
        with:
          path: ~/.cache/JetBrains/Amper
          key: ${{ runner.os }}-amper-${{ hashFiles('**/module.yaml', '**/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-amper-
      
      - name: Build and Test
        run: |
          ./amper build
          ./amper test
      
      - name: Update version in module.yaml
        run: |
          sed -i "s/version: 1.0.0/version: ${{ env.VERSION }}/" module.yaml
          grep "version:" module.yaml
      
      - name: Publish to local repository
        run: ./amper task :slop-publish:publishLocal@slop-publish
      
      - name: Prepare bundle for Central Portal
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
        run: |
          # Use artifacts from local Maven repo
          LOCAL_REPO="$HOME/.m2/repository"
          GROUP_PATH=$(echo "${{ env.GROUP_ID }}" | tr '.' '/')
          SOURCE_DIR="$LOCAL_REPO/${GROUP_PATH}/${{ env.ARTIFACT_ID }}/${{ env.VERSION }}"
          
          # Create bundle directory
          BUNDLE_DIR="bundle/${GROUP_PATH}/${{ env.ARTIFACT_ID }}/${{ env.VERSION }}"
          mkdir -p "$BUNDLE_DIR"
          
          # Copy JAR and POM (already have checksums from publishLocal)
          cp "$SOURCE_DIR"/*.jar "$BUNDLE_DIR/${{ env.ARTIFACT_ID }}-${{ env.VERSION }}.jar"
          cp "$SOURCE_DIR"/*.pom "$BUNDLE_DIR/${{ env.ARTIFACT_ID }}-${{ env.VERSION }}.pom"
          
          # Create sources JAR
          jar cvf "$BUNDLE_DIR/${{ env.ARTIFACT_ID }}-${{ env.VERSION }}-sources.jar" -C src .
          
          # Create javadoc JAR (placeholder)
          mkdir -p javadoc
          echo "<html><body><h1>slop-publish ${{ env.VERSION }}</h1><p>Maven publishing plugin for JetBrains Amper</p></body></html>" > javadoc/index.html
          jar cvf "$BUNDLE_DIR/${{ env.ARTIFACT_ID }}-${{ env.VERSION }}-javadoc.jar" -C javadoc .
          
          # Generate checksums and sign all artifacts
          cd "$BUNDLE_DIR"
          for file in *.jar *.pom; do
            md5sum "$file" | cut -d' ' -f1 > "$file.md5"
            sha1sum "$file" | cut -d' ' -f1 > "$file.sha1"
            gpg --batch --yes --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" \
                --local-user "$GPG_KEY_ID" -ab "$file"
          done
          
          # Create bundle zip
          cd ${{ github.workspace }}/bundle
          zip -r ../bundle.zip .
          
          echo "Bundle contents:"
          unzip -l ../bundle.zip
      
      - name: Upload to Central Portal
        env:
          CENTRAL_TOKEN: ${{ secrets.CENTRAL_TOKEN }}
        run: |
          echo "Uploading bundle to Central Portal..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $CENTRAL_TOKEN" \
            -F "bundle=@bundle.zip" \
            "https://central.sonatype.com/api/v1/publisher/upload?name=${{ env.ARTIFACT_ID }}-${{ env.VERSION }}&publishingType=AUTOMATIC")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Upload successful!"
            echo "Deployment ID: $BODY"
          else
            echo "Upload failed with HTTP $HTTP_CODE"
            exit 1
          fi
